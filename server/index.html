<html>
<head>
    <!--//TODO: fix refering to outside sources -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="https://raw.github.com/carhartl/jquery-cookie/master/jquery.cookie.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        $(function(){
            window.REQUEST_TYPE = {
                sendOOThreadMessage: 1,
                sendGroupThreadMessage: 2,
                sendMultiUserThreadMessage: 3,
                initiateMultiUserThread: 4,
                addFriendToMultiUserThread: 5,
                leaveMultiuserThread: 6,
                getInitData: 10,
                getOldMessages: 11,
                getMultiuserThreadDetails: 12,
                getUsersDetails: 13
            };

            window.openOneOneThread = function(userId){
                if(typeof window.iosocket != "undefined"){
                    iosocket.emit("open 1-1 thread", JSON.stringify({
                        "receiverId":userId
                    }));
                }
            }

            window.closeOneOneThread = function(userId){
                if(typeof window.iosocket != "undefined"){
                    iosocket.emit("close 1-1 thread", JSON.stringify({
                        "receiverId":userId
                    }));
                }
            }
            window.iosocket = io.connect();
 
            iosocket.once('connect', function () {
                $('#incomingChatMessages').prepend($('<li>Connected</li>'));
 
                iosocket.on('message', function(message) {
                    $('#incomingChatMessages').prepend($('<li></li>').text(message + "-" + new Date()));
                });
                iosocket.on('disconnect', function(msg) {
                    $('#incomingChatMessages').prepend('<li>Disconnected</li> - '+msg);
                });
            });
 
            $('#outgoingChatMessage').keypress(function(event) {
                if(event.which == 13) {
                    event.preventDefault();
                    iosocket.send(JSON.stringify({
                        "content":$('#outgoingChatMessage').val(),
                        "requestType": REQUEST_TYPE.sendOOThreadMessage,
                        "receiverId": 3 // TODO: change hard code
                    }));
                    $('#incomingChatMessages').prepend($('<li></li>').text($('#outgoingChatMessage').val()));
                    $('#outgoingChatMessage').val('');
                }
            });
	    $(document).ready(function(){
			    setInterval("test(100,593,1)",1000);
			    });
            window.test = function(msg_count, destination,requestType){
		window.count = window.count || 0;
                if(!msg_count) msg_count=1;
                if(!destination) destination=3;
                if(!requestType) requestType=REQUEST_TYPE.sendOOThreadMessage;
                console.log("sending " + msg_count + " message(s)");
                for(i=0;i<msg_count;i++){
                    str="";
                    for(j=0;j<0;j++)
                        str+="_";
                    message = {
                        "content":str+(window.count++)+" ",
                        "requestType": requestType
                    }
                    if(message.requestType === REQUEST_TYPE.sendOOThreadMessage){
                        message.receiverId =  destination;
                    }else if(message.requestType === REQUEST_TYPE.sendGroupThreadMessage){
                        message.groupId = destination;
                    }else if(message.requestType === REQUEST_TYPE.sendMultiUserThreadMessage){
                        message.threadId = destination;
                    
                    }else{
                        console.log("Invalid requestType");
                    }
                    iosocket.send(JSON.stringify(message));
                }
            }
        });
    </script>
</head>
<body>
Incoming Chat: <ul id="incomingChatMessages"></ul>


<input type="text" id="outgoingChatMessage">
</body>

</html>
